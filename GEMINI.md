# Gemini 텔레그램 봇 프로젝트 분석

## 1. 프로젝트 목적

이 프로젝트는 Google의 Gemini AI를 활용하여 사용자의 프롬프트를 기반으로 텍스트 응답을 생성하고, 이미지를 생성하는 기능을 제공하는 텔레그램 봇입니다. 사용자는 간단한 명령어를 통해 AI와 상호작용할 수 있으며, 사진이나 텍스트 메시지에 답장하는 방식으로도 자연스러운 대화가 가능합니다. 봇은 대화의 맥락을 기억하여 연속적인 상호작용을 지원합니다.

## 2. 주요 기능

-   **텍스트 생성:** 사용자가 입력한 프롬프트에 대해 Gemini AI가 생성한 텍스트 응답을 제공합니다. (`/gemini` 명령어)
-   **이미지 생성:** 사용자가 입력한 프롬프트를 기반으로 이미지를 생성합니다. (`/image` 명령어)
-   **대화형 응답:** 사용자가 봇의 메시지에 답장하면, 이전 대화의 맥락을 기억하여 자연스러운 대화를 이어갑니다.
-   **미디어 처리:** 사용자가 전송한 사진이나 앨범(여러 사진)을 이해하고, 이를 기반으로 명령을 수행할 수 있습니다.
-   **대화 기록:** 모든 상호작용은 SQLite 데이터베이스에 기록되어 대화의 연속성을 유지합니다.
-   **사용자 인증:** 설정 파일에 정의된 사용자 및 채널만 봇을 사용할 수 있도록 제한합니다.

## 3. 사용된 주요 기술

-   **언어:** TypeScript
-   **런타임:** Node.js
-   **텔레그램 봇 API:** `node-telegram-bot-api`
-   **Google AI:** `@google/genai`
-   **데이터베이스:** `sqlite3`
-   **테스트:** Jest
-   **기타:** `dotenv` (환경 변수), `marked` (마크다운 파싱)

## 4. 프로젝트 구조

```
.
├── dist/                     # 컴파일된 JavaScript 파일
├── node_modules/             # Node.js 모듈
├── src/                      # 소스 코드 디렉토리
│   ├── bot.ts                # 봇의 메인 진입점
│   ├── config.ts             # 환경 변수 및 설정 관리
│   ├── handlers/             # 메시지 및 명령어 처리 로직
│   │   ├── commandRouter.ts      # 사용자 의도 파악 및 명령어 라우팅
│   │   ├── mediaGroupHandler.ts  # 앨범(미디어 그룹) 메시지 처리
│   │   ├── chatCommandHandler.ts # /gemini (텍스트 생성) 명령어 처리
│   │   └── imageCommandHandler.ts# /image (이미지 생성) 명령어 처리
│   ├── services/             # 외부 서비스 연동 및 핵심 비즈니스 로직
│   │   ├── aiHandler.ts        # Google Gemini API 연동 관리
│   │   ├── auth.ts             # 사용자 권한 인증
│   │   └── db.ts               # SQLite 데이터베이스 관리
│   └── helpers/              # 보조 유틸리티 함수
│       ├── commandHelper.ts    # 명령어 처리에 필요한 공통 준비 작업
│       └── utils.ts            # 파일 처리, 메시지 분할 등 공통 유틸리티
├── tests/                    # 테스트 코드
├── .gitignore                # Git 추적 제외 파일 목록
├── Dockerfile                # Docker 이미지 생성을 위한 설정 파일
├── jest.config.cjs           # Jest 테스트 프레임워크 설정
├── package.json              # 프로젝트 의존성 및 스크립트 관리
├── pnpm-lock.yaml            # pnpm 의존성 잠금 파일
├── telegram_log.db           # 메시지 기록이 저장되는 SQLite 데이터베이스 파일
└── tsconfig.json             # TypeScript 컴파일러 설정
```

## 5. 상세 분석

### 5.1. `src/` - 핵심 소스 코드

#### `bot.ts` (메인 진입점)
-   텔레그램 봇 인스턴스를 생성하고 폴링을 시작하여 메시지를 수신합니다.
-   `/start` 명령어에 대한 도움말 메시지를 처리합니다.
-   그 외의 모든 수신 메시지를 `mediaGroupHandler`로 전달하여 본격적인 처리를 위임합니다.

#### `config.ts` (설정 관리자)
-   `dotenv`를 사용하여 `.env` 파일에서 환경 변수(API 키, 사용자 ID 등)를 로드합니다.
-   프로젝트 전역에서 사용될 설정 객체(`config`)를 생성하고 내보냅니다.
-   필수 환경 변수가 누락되었을 경우 프로세스를 중단시켜 오류를 방지합니다.

### 5.2. `src/handlers/` - 명령어 및 메시지 핸들러

#### `mediaGroupHandler.ts`
-   사용자가 여러 장의 사진(앨범)을 한 번에 보냈을 때, 이를 단일 요청으로 처리하기 위한 로직을 담당합니다.
-   `media_group_id`를 기준으로 짧은 시간 내에 들어온 메시지들을 캐싱하고, 타이머를 이용해 그룹화합니다.
-   그룹화가 완료되면 `commandRouter`로 메시지를 전달합니다. 미디어 그룹이 아닌 단일 메시지는 즉시 라우터로 전달됩니다.

#### `commandRouter.ts`
-   봇의 핵심 두뇌 역할을 하며, 사용자의 메시지를 분석하여 의도를 파악하고 적절한 핸들러로 분기합니다.
-   **사용자 인증:** `auth.ts`를 통해 메시지를 보낸 사용자가 허가된 사용자인지 확인합니다.
-   **명령어 유형 결정:** 메시지 텍스트(` /image`, `/gemini`)나 대화의 맥락(봇의 메시지에 대한 답장)을 분석하여 `image` 또는 `chat` 명령으로 분류합니다.
-   **프롬프트 유효성 검사:** 명령어만 있고 내용이 없는 경우 등 잘못된 요청을 필터링합니다.
-   분석된 결과에 따라 `chatCommandHandler` 또는 `imageCommandHandler`를 호출합니다.

#### `chatCommandHandler.ts`
-   `/gemini` 명령어 및 텍스트 기반 대화 생성을 처리합니다.
-   `commandHelper`를 사용해 대화 기록과 현재 메시지를 AI 모델이 이해할 수 있는 형식으로 준비합니다.
-   `aiHandler`를 호출하여 Gemini Pro 모델에 텍스트 생성을 요청합니다.
-   모델의 응답(텍스트, 코드 블록, 웹 검색 결과 등)을 HTML로 파싱하고 `utils.ts`의 `sendLongMessage`를 통해 사용자에게 전송합니다.

#### `imageCommandHandler.ts`
-   `/image` 명령어 및 이미지 생성 관련 대화를 처리합니다.
-   `commandHelper`를 통해 프롬프트와 컨텍스트(첨부 이미지 등)를 준비합니다.
-   `aiHandler`를 호출하여 이미지 생성 모델에 요청을 보냅니다.
-   생성된 이미지를 버퍼 형태로 받아 텔레그램 `sendPhoto` 또는 `sendMediaGroup` API를 사용해 사용자에게 전송합니다. 텍스트 응답이 함께 생성된 경우 캡션으로 추가합니다.

### 5.3. `src/services/` - 외부 연동 및 비즈니스 로직

#### `db.ts`
-   `sqlite3` 라이브러리를 사용하여 로컬 데이터베이스(`telegram_log.db`)와의 모든 상호작용을 관리합니다.
-   **스키마 정의:** 메시지, 첨부파일, 메타데이터 등을 저장하기 위한 테이블 구조를 정의하고 초기화합니다.
-   **메시지 로깅:** 수신 및 발신되는 모든 메시지의 원본 JSON과 관련 정보를 DB에 저장합니다.
-   **대화 기록 조회:** 특정 메시지에 대한 응답 체인을 재귀적으로 탐색하여 AI 모델에 컨텍스트로 제공할 대화 기록(`ConversationTurn[]`)을 생성하는 핵심 기능을 수행합니다.

#### `auth.ts`
-   간단한 사용자 인증 로직을 제공합니다.
-   `config.ts`에 정의된 `trustedUserIds` (사용자 ID 목록)와 `allowedChannelIds` (채널 ID 목록)를 기반으로 현재 요청이 유효한지 검사합니다.

#### `aiHandler.ts`
-   Google Gemini API와의 통신을 추상화한 모듈입니다.
-   `@google/genai` SDK를 사용하여 콘텐츠 생성 요청을 보냅니다.
-   **오류 처리 및 재시도:** API에서 5xx 오류(서버 과부하 등)가 발생했을 때, 지연 시간을 두고 몇 차례 재시도하는 로직이 구현되어 있습니다.
-   **안전성 검사:** API 응답이 Google의 안전 정책에 의해 차단되었는지 확인하고, 그에 맞는 오류 메시지를 반환합니다.
-   **응답 파싱:** API 응답에서 텍스트, 이미지, 메타데이터 등을 추출하여 일관된 `GenerationOutput` 객체로 정규화하여 반환합니다.

### 5.4. `src/helpers/` - 보조 유틸리티

#### `utils.ts`
-   프로젝트 전반에서 사용되는 다양한 공통 함수를 제공합니다.
-   **파일 처리:** `bot.getFileStream`으로 받은 파일 스트림을 `Buffer`로 변환하고, 메모리 캐시(`imageCache`)를 운영하여 동일 파일의 중복 다운로드를 방지합니다.
-   **콘텐츠 빌더 (`buildContents`):** `db.ts`에서 가져온 대화 기록과 현재 메시지의 파일들을 취합하여 Gemini API가 요구하는 최종 `Content[]` 배열 형식으로 구성합니다.
-   **메시지 분할 (`sendLongMessage`):** 텔레그램의 메시지 최대 길이(4096자)를 초과하는 긴 응답을 코드 블록(`
<pre>`) 등을 고려하여 여러 개의 메시지로 안전하게 분할하여 순차적으로 전송합니다.

#### `commandHelper.ts`
-   명령어 핸들러들의 공통 준비 작업을 돕는 함수를 제공합니다.
-   **콘텐츠 준비 (`prepareContentForModel`):** 명령어 실행에 앞서 대화 기록을 가져오고, `utils.ts`의 `buildContents`를 호출하여 모델에 보낼 콘텐츠를 생성합니다. 이 과정에서 총 파일 크기가 제한을 초과하는지 검사합니다.
-   **오류 핸들러 (`handleCommandError`):** 각 명령어 핸들러의 `try...catch` 블록에서 예외 발생 시 호출되어, 오류를 콘솔에 로깅하고 사용자에게 일관된 오류 메시지를 보내는 역할을 합니다.

## 6. @tests - 테스트

이 프로젝트는 `Jest`를 테스트 프레임워크로 사용하여 코드의 안정성과 신뢰성을 확보합니다. 단위 테스트와 통합 테스트를 통해 핵심 로직이 예상대로 동작하는지 검증합니다.

### 6.1. 테스트 전략

-   **의존성 모킹(Mocking):** `node-telegram-bot-api`, `@google/genai`, `sqlite3`와 같은 외부 라이브러리와의 의존성을 `jest.mock`을 사용하여 가상으로 구현합니다. 이를 통해 각 테스트 단위를 외부 환경의 영향 없이 독립적으로 검증할 수 있습니다.
-   **계층별 테스트:** `services`, `handlers`, `helpers` 등 각 모듈의 역할에 맞춰 테스트를 구성하여 특정 기능의 동작을 정밀하게 확인할 수 있습니다.

### 6.2. 테스트 구조

`tests/` 디렉토리는 `src/` 디렉토리의 구조를 그대로 반영하여 테스트 파일과 소스 코드 간의 연관성을 쉽게 파악할 수 있도록 구성되어 있습니다.

-   `tests/services/`: `db.service.test.ts`, `auth.service.test.ts`, `aiHandler.service.test.ts` 등 서비스 계층의 비즈니스 로직을 테스트합니다.
-   `tests/handlers/`: `commandRouter.handler.test.ts`, `mediaGroupHandler.handler.test.ts` 등 사용자의 입력을 처리하고 라우팅하는 핸들러의 동작을 검증합니다.
-   `tests/helpers/`: `utils.helper.test.ts`와 같이 프로젝트 전반에서 사용되는 유틸리티 함수의 정확성을 테스트합니다.

### 6.3. 주요 테스트 영역

-   **AI 핸들러 (`aiHandler.service.test.ts`):** Gemini API 호출 시 발생할 수 있는 네트워크 오류, API의 안전성 설정에 의한 차단 등 다양한 예외 상황에 대한 재시도 및 오류 처리 로직을 중점적으로 검증합니다.
-   **명령어 라우터 (`commandRouter.handler.test.ts`):** 사용자의 메시지(텍스트, 답장, 미디어 등)에 따라 정확한 명령어로 분기되는지, 잘못된 프롬프트는 올바르게 거절되는지를 테스트합니다.
-   **데이터베이스 서비스 (`db.service.test.ts`):** 대화 기록을 조회하고, AI 모델이 요구하는 형식(`ConversationTurn[]`)으로 정확하게 가공하는 로직을 집중적으로 테스트합니다.
